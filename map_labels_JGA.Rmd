---
title: "Not overlapping labels JGA"
output: html_document
date: "2024-11-19"
---


```{r}

#library(leaflet.extras)
library(leaflet)
library(sf)
library(htmltools)

member.table <- read.csv(here::here("MembersInfo.csv"))

member.filt = member.table |> 
  select(Nombre, Afiliación)


institutions <- member.table |> 
  distinct(Afiliación) |> 
  mutate(af = stringr::str_replace_all(Afiliación, " ", "+"),
         af = stringr::str_replace_all(af, ",", ""),
         af = stringr::str_replace_all(af, "\n", "+"))

url = paste0(
  "http://nominatim.openstreetmap.org/search?q=",
  institutions$af[2], #"Universidad+California+Davis"
  "&limit=9&format=json")

resOSM = fromJSON(url)

c(resOSM[[1]]$lon, resOSM[[1]]$lat)

locateAFF = function(afiliation) {
  url = paste0(
    "http://nominatim.openstreetmap.org/search?q=",
    afiliation,
    "&limit=9&format=json")
  resOSM = fromJSON(url)
  if(length(resOSM) > 0) {
    return(c(resOSM[[1]]$lon, resOSM[[1]]$lat))
  } else return(rep(NA,2)) 
}

#Try function:
#locateAFF(institutions$af[3])

coords <- lapply(institutions$af, locateAFF)

df.coords <- t(as.data.frame(coords))

institutions$lon <- df.coords[,1]
institutions$lat <- df.coords[,2]

head(institutions)[,-2]


member.complete <- left_join(member.filt, institutions, by = "Afiliación")

points <- member.complete |> 
  #filter(Afiliación=="Universidad Autónoma de Madrid") |> 
  filter(!is.na(lon)) |> 
  st_as_sf(coords = c("lon", "lat"))

leaflet(points) |> 
  addTiles() |> 
  addMarkers(popup = points, 
             label = ~(Nombre),
             labelOptions = labelOptions(zoomAnimation = T),
             clusterOptions = markerClusterOptions())
   #addProviderTiles(Esri.WorldGrayCanvas")
  
```